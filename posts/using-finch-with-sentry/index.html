<!doctype html><html lang=en><head><title>Using Finch With Sentry ::
Claudio Ortolina — My personal website</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A few weeks ago I added enabled support for Sentry inside Tune, my Spotify browser/client. Even if I&amp;#39;m pretty much the only user (I built it for myself after all), having exception tracking has already proved to be useful - band and song names can really create all sorts of issues.
 The official Sentry package works as advertised and by default it communicates using Hackney as a http client."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=http://claudio-ortolina.org/posts/using-finch-with-sentry/><link rel=stylesheet href=http://claudio-ortolina.org/assets/style.css><link rel=stylesheet href=http://claudio-ortolina.org/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=http://claudio-ortolina.org/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=http://claudio-ortolina.org/img/favicon.png><link href=http://claudio-ortolina.org/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Finch With Sentry"><meta name=twitter:description content="How to setup Sentry to use the Finch HTTP Client"><meta property="og:title" content="Using Finch With Sentry"><meta property="og:description" content="How to setup Sentry to use the Finch HTTP Client"><meta property="og:type" content="article"><meta property="og:url" content="http://claudio-ortolina.org/posts/using-finch-with-sentry/"><meta property="article:published_time" content="2020-11-10T08:41:30+00:00"><meta property="article:modified_time" content="2020-11-10T08:41:30+00:00"><meta property="og:site_name" content="Claudio Ortolina"><script async defer data-domain=claudio-ortolina.org src=https://plausible.io/js/plausible.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Claudio Ortolina</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/talks>Talks</a></li><li><a href=https://github.com/cloud8421/claudio-ortolina.org>Source</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/talks>Talks</a></li><li><a href=https://github.com/cloud8421/claudio-ortolina.org>Source</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Using Finch With Sentry</h1><div class=post-meta><span class=post-date>2020-11-10</span>
<span class=post-read-time>— 2 min read</span></div><span class=post-tags><a href=http://claudio-ortolina.org/tags/elixir/>#elixir</a>&nbsp;
<a href=http://claudio-ortolina.org/tags/software-development/>#software development</a>&nbsp;</span><div class=post-content><p>A few weeks ago I added enabled support for <a href=https://sentry.io>Sentry</a> inside <a href=https://github.com/fully-forged/tune>Tune</a>, my Spotify browser/client. Even if I'm pretty much the only user (I built it for myself after all), having exception tracking has already proved to be useful - band and song names can really create all sorts of issues.</p><p>The <a href=https://hex.pm/packages/sentry>official Sentry package</a> works as advertised and by default it communicates using <a href=https://hex.pm/packages/hackney>Hackney</a> as a http client. As I've been using <a href=https://hex.pm/packages/finch>Finch</a> in the project, I was pleased to see that Sentry exposed a <code>client</code> configuration option that allowed using your own module, as long as it implemented the <code>Sentry.HTTPClient</code> behaviour.</p><p>The advantage in swapping the http client library (on top of uniforming the building blocks of the application) is that Finch has support for <a href=https://hex.pm/packages/telemetry>Telemetry</a> metrics.</p><blockquote><p>Update #1: Thanks to Wojtek Mach for <a href=https://github.com/fully-forged/tune/pull/131>a more streamlined implementation.</a></p></blockquote><p>The module I wrote is quite short:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>Sentry.FinchClient</span> <span style=color:#66d9ef>do</span>
  <span style=color:#a6e22e>@moduledoc</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span><span style=color:#e6db74>  Defines a small shim to use `Finch` as a `Sentry.HTTPClient`.
</span><span style=color:#e6db74>  &#34;&#34;&#34;</span>

  <span style=color:#a6e22e>@behaviour</span> <span style=color:#a6e22e>Sentry.HTTPClient</span>

  <span style=color:#a6e22e>@impl</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>def</span> child_spec <span style=color:#66d9ef>do</span>
    <span style=color:#a6e22e>Finch</span><span style=color:#f92672>.</span>child_spec(<span style=color:#e6db74>name</span>: <span style=color:#a6e22e>Sentry.Finch</span>)
  <span style=color:#66d9ef>end</span>

  <span style=color:#a6e22e>@impl</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>def</span> post(url, headers, body) <span style=color:#66d9ef>do</span>
    request <span style=color:#f92672>=</span> <span style=color:#a6e22e>Finch</span><span style=color:#f92672>.</span>build(<span style=color:#e6db74>:post</span>, url, headers, body)

    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Finch</span><span style=color:#f92672>.</span>request(request, <span style=color:#a6e22e>Sentry.Finch</span>) <span style=color:#66d9ef>do</span>
      {<span style=color:#e6db74>:ok</span>, response} <span style=color:#f92672>-&gt;</span>
        {<span style=color:#e6db74>:ok</span>, response<span style=color:#f92672>.</span>status, response<span style=color:#f92672>.</span>headers, response<span style=color:#f92672>.</span>body}

      error <span style=color:#f92672>-&gt;</span>
        error
    <span style=color:#66d9ef>end</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span></code></pre></div></div><p>The trickiest bit was to get the <code>child_spec/0</code> callback right while keeping <a href=https://erlang.org/doc/man/dialyzer.html>dialyzer</a> happy. The first implementation I wrote was simply <code>{Finch, name: Sentry.Finch}</code>, but that would fail to satisfy <a href=https://hexdocs.pm/sentry/Sentry.HTTPClient.html#c:child_spec/0>the typespec defined for <code>child_spec/0</code></a>. I then switched to a more verbose version:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>  <span style=color:#66d9ef>def</span> child_spec <span style=color:#66d9ef>do</span>
    opts <span style=color:#f92672>=</span> [<span style=color:#e6db74>name</span>: <span style=color:#a6e22e>Sentry.Finch</span>]

    <span style=color:#a6e22e>Supervisor</span><span style=color:#f92672>.</span>child_spec(
      %{
        <span style=color:#e6db74>id</span>: __MODULE__,
        <span style=color:#e6db74>start</span>: {<span style=color:#a6e22e>Finch</span>, <span style=color:#e6db74>:start_link</span>, [opts]},
        <span style=color:#e6db74>type</span>: <span style=color:#e6db74>:supervisor</span>
      },
      []
    )
  <span style=color:#66d9ef>end</span></code></pre></div></div><p>This version satisfied dialyzer, but turns out there's a simpler way. After publishing this blog post, Wojtek Mach reached out and submitted a PR to streamline the specification to the version shown in the full example above.</p><p>I also updated my production configuration:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>config <span style=color:#e6db74>:sentry</span>,
  <span style=color:#e6db74>dsn</span>: {<span style=color:#e6db74>:system</span>, <span style=color:#e6db74>&#34;SENTRY_DSN&#34;</span>},
  <span style=color:#e6db74>environment_name</span>: <span style=color:#e6db74>:prod</span>,
  <span style=color:#e6db74>enable_source_code_context</span>: <span style=color:#66d9ef>true</span>,
  <span style=color:#e6db74>root_source_code_path</span>: <span style=color:#a6e22e>File</span><span style=color:#f92672>.</span>cwd!(),
  <span style=color:#e6db74>client</span>: <span style=color:#a6e22e>Sentry.FinchClient</span>,
  <span style=color:#e6db74>included_environments</span>: [<span style=color:#e6db74>:prod</span>]</code></pre></div></div><p>You can of course expand on this implementation if you need to pass more options to the <code>Finch</code> child specification - I found that for my use case, defaults are fine, so for now I don't need to add any configuration hooks.</p><p>To see the change in context, <a href=https://github.com/fully-forged/tune/pull/122>this is the original PR</a>, with the <a href=https://github.com/fully-forged/tune/pull/131>follow-up by Wojtek Mach</a>.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=http://claudio-ortolina.org/posts/fish/><span class=button__text>Fish</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user">Copyright 2020 © Claudio Ortolina</div></div></footer><script src=http://claudio-ortolina.org/assets/main.js></script><script src=http://claudio-ortolina.org/assets/prism.js></script></div></body></html>