<!doctype html><html lang=en><head><title>Building a Custom Page for Phoenix Live Dashboard ::
Claudio Ortolina — My personal website</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Step by step instructions on how to build a custom Phoenix Live Dashboard page"><meta name=keywords content="elixir,phoenix,phoenix live dashboard,debug,monitoring"><meta name=robots content="noodp"><link rel=canonical href=http://claudio-ortolina.org/posts/building-a-custom-page-for-phoenix-live-dashboard/><link rel=stylesheet href=http://claudio-ortolina.org/assets/style.css><link rel=stylesheet href=http://claudio-ortolina.org/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=http://claudio-ortolina.org/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=http://claudio-ortolina.org/img/favicon.png><link href=http://claudio-ortolina.org/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://claudio-ortolina.org/img/building-a-custom-page-for-phoenix-live-dashboard/sessions-table.png"><meta name=twitter:title content="Building a Custom Page for Phoenix Live Dashboard"><meta name=twitter:description content="Gradually building a full-featured page to explore Tune sessions"><meta property="og:title" content="Building a Custom Page for Phoenix Live Dashboard"><meta property="og:description" content="Gradually building a full-featured page to explore Tune sessions"><meta property="og:type" content="article"><meta property="og:url" content="http://claudio-ortolina.org/posts/building-a-custom-page-for-phoenix-live-dashboard/"><meta property="og:image" content="http://claudio-ortolina.org/img/building-a-custom-page-for-phoenix-live-dashboard/sessions-table.png"><meta property="article:published_time" content="2020-11-21T09:29:01+00:00"><meta property="article:modified_time" content="2020-11-21T09:29:01+00:00"><meta property="og:site_name" content="Claudio Ortolina"><script defer data-domain=claudio-ortolina.org src=https://plausible.io/js/plausible.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Claudio Ortolina</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/talks>Talks</a></li><li><a href=https://github.com/cloud8421/claudio-ortolina.org>Source</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/talks>Talks</a></li><li><a href=https://github.com/cloud8421/claudio-ortolina.org>Source</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Building a Custom Page for Phoenix Live Dashboard</h1><div class=post-meta><span class=post-date>2020-11-21</span>
<span class=post-read-time>— 8 min read</span></div><span class=post-tags><a href=http://claudio-ortolina.org/tags/elixir/>#elixir</a>&nbsp;
<a href=http://claudio-ortolina.org/tags/software-development/>#software development</a>&nbsp;</span><div class=post-content><p>One of the most interesting features provided by Phoenix Live Dashboard is the ability to <a href=https://hexdocs.pm/phoenix_live_dashboard/Phoenix.LiveDashboard.PageBuilder.html#content>define your own pages</a>, so that you can quickly and reliably extend a Live Dashboard instance with sections that are tailored to your application domain.</p><p>While working on <a href=https://github.com/fully-forged/tune>Tune</a>, I found a use case suitable for a custom live dashboard page: a debugging view where I can check open sessions and inspect the underlying processes.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>On the use case</h2><div id=outline-text-headline-1 class=outline-text-2><p>I would encourage you to read <a href=https://github.com/fully-forged/tune>Tune's README</a> to understand the use case in more detail, but I'll quote the relevant architectural section:</p><blockquote><p>Tune assumes multiple browser sessions for the same user, which is why it defines a <a href=https://tune-docs.fullyforged.com/Tune.Spotify.Session.html#content><code>Tune.Spotify.Session</code></a> behaviour with <a href=https://tune-docs.fullyforged.com/Tune.Spotify.Session.HTTP.html#content><code>Tune.Spotify.Session.HTTP</code></a> as its main runtime implementation.</p><p>Each worker is responsible to proxy interaction with the Spotify API, periodically poll for data changes, and broadcast corresponding events.</p><p>When a user opens a browser session, <a href=https://tune-docs.fullyforged.com/TuneWeb.ExplorerLive.html#content><code>TuneWeb.ExplorerLive</code></a> either starts or simply reuses a worker named with the same session ID.</p><p>Each worker monitors its subscribers, so that it can shutdown when a user closes their last browser window.</p><p>This architecture ensures that:</p><ul><li><p>The amount of automatic API calls against the Spotify API for a given user is constant and independent from the number of user sessions for the same user.</p></li><li><p>Credential renewal happens in the background</p></li><li><p>The explorer implementation remains entirely focused on UI interaction</p></li></ul></blockquote><p>In other words:</p><ul><li><p>For each Spotify account connected, there can only be one session (a <code>Tune.Spotify.Session.HTTP</code> process named with the session ID).</p></li><li><p>For each session, there can be many open clients (i.e. browser windows or <code>TuneWeb.ExplorerLive</code> process).</p></li></ul></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Requirements</h2><div id=outline-text-headline-2 class=outline-text-2><p>Our dashboard page will include:</p><ul><li><p>A table with session IDs, PIDs and count of open clients</p></li><li><p>Ability to sort by session ID or clients count</p></li><li><p>Search by session ID</p></li><li><p>Support multiple nodes</p></li></ul></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Gathering the necessary data</h2><div id=outline-text-headline-3 class=outline-text-2><p>To populate the dashboard table, we first need to find a way to get a list of all active sessions, along with their clients count.</p><p>The simplest way is to leverage the fact that each <code>Tune.Spotify.Session.HTTP</code> process is started with a name managed via a <a href=https://hexdocs.pm/elixir/Registry.html>Registry</a>, with the session ID as a key. Registration is in place to guarantee that there can only be one session process with the same ID on each node.</p><p>We can use <a href=https://hexdocs.pm/elixir/Registry.html#select/2><code>Registry.select/2</code></a> to query the registry and receive back all session IDs and PIDs:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#a6e22e>Registry</span><span style=color:#f92672>.</span>select(
  <span style=color:#a6e22e>Tune.Spotify.SessionRegistry</span>,
  [{{<span style=color:#e6db74>:&#34;$1&#34;</span>, <span style=color:#e6db74>:&#34;$2&#34;</span>, <span style=color:#e6db74>:_</span>}, [], [{{<span style=color:#e6db74>:&#34;$1&#34;</span>, <span style=color:#e6db74>:&#34;$2&#34;</span>}}]}]
)</code></pre></div></div><p>Which returns:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>[{<span style=color:#e6db74>&#34;claudio.ortolina&#34;</span>, <span style=color:#75715e>#PID&lt;0.565.0&gt;}]</span></code></pre></div></div><p>In the example above, we use a match specification to capture the registry key (the session ID) and the registered PID.</p><p>It's important to understand straight away the constraints associated with this approach:</p><ul><li><p>A <code>Registry</code> is normally split into a variable number of partitions, so this query has to visit all partitions to return its results. While this is not a problem at this stage (the application has very little load), it can become a bottleneck once the number of registered processes grows.</p></li><li><p>As data is partitioned, it's not possible to apply sort order or limit the results without concatenating them all first, which means that both operations will need to be done by the caller.</p></li><li><p>Results only apply to the current node, which works well with Phoenix Live Dashboard's general structure, which always operates on one node at a time.</p></li></ul><p>Given the registry query above, we can implement a function that provides the data necessary to populate an unfiltered, unsorted version of the table:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>Tune.Spotify.Supervisor</span> <span style=color:#66d9ef>do</span>
  <span style=color:#75715e># omitted</span>
  <span style=color:#66d9ef>def</span> sessions <span style=color:#66d9ef>do</span>
    <span style=color:#a6e22e>Tune.Spotify.SessionRegistry</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Registry</span><span style=color:#f92672>.</span>select([{{<span style=color:#e6db74>:&#34;$1&#34;</span>, <span style=color:#e6db74>:&#34;$2&#34;</span>, <span style=color:#e6db74>:_</span>}, [], [{{<span style=color:#e6db74>:&#34;$1&#34;</span>, <span style=color:#e6db74>:&#34;$2&#34;</span>}}]}])
    <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>map(<span style=color:#66d9ef>fn</span> {id, pid} <span style=color:#f92672>-&gt;</span>
      subscribers_count <span style=color:#f92672>=</span> <span style=color:#a6e22e>Tune.Spotify.Session.HTTP</span><span style=color:#f92672>.</span>subscribers_count(id)
      %{<span style=color:#e6db74>id</span>: id, <span style=color:#e6db74>pid</span>: pid, <span style=color:#e6db74>clients_count</span>: subscribers_count}
    <span style=color:#66d9ef>end</span>)
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span></code></pre></div></div><p>The resulting data structure is a map with the necessary data:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>[%{<span style=color:#e6db74>clients_count</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>id</span>: <span style=color:#e6db74>&#34;claudio.ortolina&#34;</span>, <span style=color:#e6db74>pid</span>: <span style=color:#75715e>#PID&lt;0.565.0&gt;}]</span></code></pre></div></div></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Dashboard page structure</h2><div id=outline-text-headline-4 class=outline-text-2><p>To build a dashboard page, we need to:</p><ol><li><p>Create a module that implements the <code>use Phoenix.LiveDashboard.PageBuilder</code> behaviour.</p></li><li><p>Mount that module into the Live Dashboard configuration defined into our application router.</p></li></ol><p>What follows is a minimal implementation that shows the data we need, with the following limitations:</p><ul><li><p>no searching, sorting or limiting capabilities</p></li><li><p>works only on a single node</p></li></ul><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>TuneWeb.LiveDashboard.SpotifySessionsPage</span> <span style=color:#66d9ef>do</span>
  <span style=color:#a6e22e>@moduledoc</span> <span style=color:#66d9ef>false</span>
  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Phoenix.LiveDashboard.PageBuilder</span>

  <span style=color:#a6e22e>@impl</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>def</span> menu_link(_, _) <span style=color:#66d9ef>do</span>
    {<span style=color:#e6db74>:ok</span>, <span style=color:#e6db74>&#34;Spotify Sessions&#34;</span>}
  <span style=color:#66d9ef>end</span>

  <span style=color:#a6e22e>@impl</span> <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>def</span> render_page(_assigns) <span style=color:#66d9ef>do</span>
    table(
      <span style=color:#e6db74>columns</span>: columns(),
      <span style=color:#e6db74>id</span>: <span style=color:#e6db74>:spotify_sessions</span>,
      <span style=color:#e6db74>row_attrs</span>: <span style=color:#f92672>&amp;</span>row_attrs<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>,
      <span style=color:#e6db74>row_fetcher</span>: <span style=color:#f92672>&amp;</span>fetch_sessions<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>,
      <span style=color:#e6db74>rows_name</span>: <span style=color:#e6db74>&#34;sessions&#34;</span>,
      <span style=color:#e6db74>title</span>: <span style=color:#e6db74>&#34;Spotify Sessions&#34;</span>
    )
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>defp</span> fetch_sessions(_params, _node) <span style=color:#66d9ef>do</span>
    <span style=color:#75715e># returns [%{clients_count: 1, id: &#34;claudio.ortolina&#34;, pid: #PID&lt;0.565.0&gt;}]</span>
    sessions <span style=color:#f92672>=</span> <span style=color:#a6e22e>Tune.Spotify.Supervisor</span><span style=color:#f92672>.</span>sessions()

    {sessions, length(sessions)}
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>defp</span> columns <span style=color:#66d9ef>do</span>
    [
      %{<span style=color:#e6db74>field</span>: <span style=color:#e6db74>:id</span>, <span style=color:#e6db74>header</span>: <span style=color:#e6db74>&#34;Session ID&#34;</span>, <span style=color:#e6db74>sortable</span>: <span style=color:#e6db74>:asc</span>},
      %{
        <span style=color:#e6db74>field</span>: <span style=color:#e6db74>:pid</span>,
        <span style=color:#e6db74>header</span>: <span style=color:#e6db74>&#34;Worker PID&#34;</span>,
        <span style=color:#e6db74>format</span>: <span style=color:#f92672>&amp;</span>(&amp;1 <span style=color:#f92672>|&gt;</span> encode_pid() <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>replace_prefix(<span style=color:#e6db74>&#34;PID&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>))
      },
      %{<span style=color:#e6db74>field</span>: <span style=color:#e6db74>:clients_count</span>, <span style=color:#e6db74>header</span>: <span style=color:#e6db74>&#34;Clients count&#34;</span>, <span style=color:#e6db74>sortable</span>: <span style=color:#e6db74>:asc</span>}
    ]
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>defp</span> row_attrs(session) <span style=color:#66d9ef>do</span>
    [
      {<span style=color:#e6db74>&#34;phx-click&#34;</span>, <span style=color:#e6db74>&#34;show_info&#34;</span>},
      {<span style=color:#e6db74>&#34;phx-value-info&#34;</span>, encode_pid(session[<span style=color:#e6db74>:pid</span>])},
      {<span style=color:#e6db74>&#34;phx-page-loading&#34;</span>, <span style=color:#66d9ef>true</span>}
    ]
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span></code></pre></div></div><p>The main ingredients of this implementation are:</p><ul><li><p>The <code>use Phoenix.LiveDashboard.PageBuilder</code> directive, which adopts the behaviour with the same name and imports some convenience functions useful for building pages (e.g. <code>encode_pid/1</code>).</p></li><li><p>The <code>menu_link/2</code> callback, which is used to define the name of the page and its label in the top navigation bar.</p></li><li><p>The <code>render_page/2</code> callback, which has to return a valid <a href=https://hexdocs.pm/phoenix_live_dashboard/Phoenix.LiveDashboard.PageBuilder.html#t:component/0><code>component</code></a> - in this case via the <a href=https://hexdocs.pm/phoenix_live_dashboard/Phoenix.LiveDashboard.PageBuilder.html#table/1><code>table/1</code></a> function.</p></li></ul><p>The table definition has a few moving parts:</p><ul><li><p>An <code>id</code> (unique among other Live Dashboard pages).</p></li><li><p>A <code>title</code>, shown in the page.</p></li><li><p>A <code>rows_name</code>, interpolated in the short text blurb that details the total amount of results.</p></li><li><p>A <code>columns</code> attribute, which is a list of maps detailing the properties of each column.</p><p>For each column, the <code>id</code> property has to map to a key in the data we will use to populate the table.</p><p>The <code>sortable</code> property defines which column can be used for sorting (by clicking on the header chevron). Note that unless you specify a <code>default_sort_by</code> attribute for the entire table, you have to have at least one column with the <code>sortable</code> property defined, otherwise you will get a compile error.</p><p>The <code>format</code> function takes the raw value for a cell in the column and transforms it to a string. It's useful to provide a string representation of the value that is suitable for an HTML table. In the code above, we copy the format function defined in <a href=https://github.com/phoenixframework/phoenix_live_dashboard/blob/8d7148d9c333a27766ee8bc971d4dba93c0f9695/lib/phoenix/live_dashboard/pages/processes_page.ex#L34>the Processes Live Dashboard page</a>.</p></li><li><p>A <code>row_attrs</code> function, which takes the data for each row and has to return a list of tuples representing the Phoenix LiveView attributes to apply to the table row itself. Defining attribute is necessary to enable functionality activated by clicking on the row itself. The implementation in this example lets you inspect the session PID in a modal overlay.</p><p>Similar to the <code>format</code> function, we leverage <code>encode_pid/1</code> to format the PID as string compatible with the <code>show_info</code> LiveView event.</p></li><li><p>A <code>row_fetcher</code> function, which takes the current <code>params</code> (search query, limit, sort key, sort direction) and the current node, and returns the data used to populate the table.</p><p>The return value has to conform to a tuple shape where the first value is a list of sessions (in the shape of maps with the same keys used for column ids) and the second value is the total number of results (irrespectively of the limit).</p><p>As we implemented <code>Tune.Spotify.Supervisor.sessions/0</code> taking care of using the same key names, its return value perfectly fits the expectations of the <code>row_fetcher</code> function.</p></li></ul></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Mounting the dashboard page</h2><div id=outline-text-headline-5 class=outline-text-2><p>To have the page up and running, we need to modify the <code>live_dashboard/2</code> function inside the application router:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>live_dashboard <span style=color:#e6db74>&#34;/dashboard&#34;</span>,
  <span style=color:#e6db74>metrics</span>: <span style=color:#a6e22e>TuneWeb.Telemetry</span>,
  <span style=color:#e6db74>metrics_history</span>: {<span style=color:#a6e22e>TuneWeb.Telemetry.Storage</span>, <span style=color:#e6db74>:metrics_history</span>, []},
  <span style=color:#e6db74>additional_pages</span>: [
    <span style=color:#e6db74>spotify_sessions</span>: <span style=color:#a6e22e>TuneWeb.LiveDashboard.SpotifySessionsPage</span>
  ]</code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-2><h2 id=headline-6>Filters and limits</h2><div id=outline-text-headline-6 class=outline-text-2><p>We can now focus on implementing search, sorting and limits. Conceptually, we need to:</p><ul><li><p>If specified, apply the search filter.</p></li><li><p>Always apply sort order.</p></li><li><p>Count the sorted elements, to return the correct total.</p></li><li><p>Always apply the limit clause to the sorted elements.</p></li></ul><p>All of these operations have to be handled by the implementation of the <code>row_fetcher</code> function.</p><p>The params map has the following keys:</p><ul><li><p><code>:search</code>: the string representing the contents of the search input (or <code>nil</code> when empty).</p></li><li><p><code>:sort_by</code>: the id of the column to sort by.</p></li><li><p><code>:sort_dir</code>: the sort direction, expressed with the atoms <code>:asc</code> and <code>:desc</code>.</p></li><li><p><code>:limit</code>: the integer value representing the amount of max items requested by the user.</p></li></ul><p>The params map is very well thought out, as it has a fixed structure, applied defaults where available and values that play well with functions from the <code>Enum</code> module.</p><p>We can extend the <code>fetch_sessions/2</code> function as follows:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>TuneWeb.LiveDashboard.SpotifySessionsPage</span> <span style=color:#66d9ef>do</span>
  <span style=color:#75715e># omitted</span>

  <span style=color:#66d9ef>defp</span> fetch_sessions(params, _node) <span style=color:#66d9ef>do</span>
    sessions <span style=color:#f92672>=</span>
      <span style=color:#a6e22e>Tune.Spotify.Supervisor</span><span style=color:#f92672>.</span>sessions()
      <span style=color:#f92672>|&gt;</span> filter(params)

    {<span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>take(sessions, params[<span style=color:#e6db74>:limit</span>]), length(sessions)}
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>defp</span> filter(sessions, params) <span style=color:#66d9ef>do</span>
    sessions
    <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>filter(<span style=color:#66d9ef>fn</span> session <span style=color:#f92672>-&gt;</span> session_match?(session, params[<span style=color:#e6db74>:search</span>]) <span style=color:#66d9ef>end</span>)
    <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>sort_by(<span style=color:#66d9ef>fn</span> session <span style=color:#f92672>-&gt;</span> session[params[<span style=color:#e6db74>:sort_by</span>]] <span style=color:#66d9ef>end</span>, params[<span style=color:#e6db74>:sort_dir</span>])
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>defp</span> session_match?(_session, <span style=color:#66d9ef>nil</span>), <span style=color:#e6db74>do</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>defp</span> session_match?(session, search_string), <span style=color:#e6db74>do</span>: <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>contains?(session[<span style=color:#e6db74>:id</span>], search_string)
<span style=color:#66d9ef>end</span></code></pre></div></div><p>As outlined above, we start by filtering by search, using a very simple logic that just checks if the session ID contains the searched string.</p><p>After search, we apply the sorting logic: the values of the <code>:sort_by</code> and <code>:sort_dir</code> perfectly fit using <code>Enum.sort_by/3</code> (a really appreciated API design choice), making the implementation short and sweet.</p><p>When defining the returning tuple, we take care of applying the limit and returning the correct total count.</p><p>With these changes in place, the generated table behaves as expected:</p><p><img src=/img/building-a-custom-page-for-phoenix-live-dashboard/sessions-table.png alt="A screenshot of the Spotify sessions table built in this blog post" class=left></p></div></div><div id=outline-container-headline-7 class=outline-2><h2 id=headline-7>Supporting multiple nodes</h2><div id=outline-text-headline-7 class=outline-text-2><p>The last piece of the puzzle is making sure that we take into account the currently selected node.</p><p>Fortunately, we just need to make a very small change to <code>fetch_sessions/2</code>:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#66d9ef>defp</span> fetch_sessions(params, node) <span style=color:#66d9ef>do</span>
  sessions <span style=color:#f92672>=</span>
    node
    <span style=color:#f92672>|&gt;</span> <span style=color:#e6db74>:rpc</span><span style=color:#f92672>.</span>call(<span style=color:#a6e22e>Tune.Spotify.Supervisor</span>, <span style=color:#e6db74>:sessions</span>, [])
    <span style=color:#f92672>|&gt;</span> filter(params)

  {<span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>take(sessions, params[<span style=color:#e6db74>:limit</span>]), length(sessions)}
<span style=color:#66d9ef>end</span></code></pre></div></div><p>The OTP <a href=https://erlang.org/doc/man/rpc.html>rpc</a> module conveniently provides a <a href=https://erlang.org/doc/man/rpc.html#call-4><code>call/4</code></a> function that takes a node name, module, function, and arguments, returning the exact same value of the remotely executed function.</p></div></div><div id=outline-container-headline-8 class=outline-2><h2 id=headline-8>Conclusions</h2><div id=outline-text-headline-8 class=outline-text-2><p>To see the final version of <code>TuneWeb.LiveDashboard.SpotifySessionsPage</code>, you can open <a href=https://github.com/fully-forged/tune/blob/32038997bc89f94ca8ee18f80d2f1cae946f7acb/lib/tune_web/live_dashboard/spotify_sessions_page.ex>the file in the repo</a>.</p></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=http://claudio-ortolina.org/posts/the-race-for-space/><span class=button__icon>←</span>
<span class=button__text>The Race for Space</span></a></span>
<span class="button next"><a href=http://claudio-ortolina.org/posts/tips-for-finch-and-telemetry/><span class=button__text>Tips for Finch, Telemetry, and Phoenix Live Dashboard</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><p xmlns:dct=http://purl.org/dc/terms/ xmlns:cc=http://creativecommons.org/ns# class=license-text><a rel=cc:attributionurl property="dct:title" href=https://claudio-ortolina.org>This website</a> by <a rel="cc:attributionurl dct:creator" property="cc:attributionName" href=https://claudio-ortolina.org>Claudio Ortolina</a> is licensed under <a rel=license href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a></p></div></div></footer><script src=http://claudio-ortolina.org/assets/main.js></script><script src=http://claudio-ortolina.org/assets/prism.js></script></div></body></html>