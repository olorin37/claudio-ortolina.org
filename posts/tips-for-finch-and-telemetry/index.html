<!doctype html><html lang=en><head><title>Tips for Finch, Telemetry, and Phoenix Live Dashboard ::
Claudio Ortolina — My personal website</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A collection of tips to customize the interaction between Finch, Telemetry, and Phoenix Live Dashboard"><meta name=keywords content="elixir,telemetry,finch,phoenix live dashboard"><meta name=robots content="noodp"><link rel=canonical href=http://claudio-ortolina.org/posts/tips-for-finch-and-telemetry/><link rel=stylesheet href=http://claudio-ortolina.org/assets/style.css><link rel=stylesheet href=http://claudio-ortolina.org/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=http://claudio-ortolina.org/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=http://claudio-ortolina.org/img/favicon.png><link href=http://claudio-ortolina.org/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=http://claudio-ortolina.org/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://claudio-ortolina.org/img/tips-for-finch-and-telemetry/charts.png"><meta name=twitter:title content="Tips for Finch, Telemetry, and Phoenix Live Dashboard"><meta name=twitter:description content="A collection of tips to customize the interaction between Finch, Telemetry, and Phoenix Live Dashboard"><meta property="og:title" content="Tips for Finch, Telemetry, and Phoenix Live Dashboard"><meta property="og:description" content="A collection of tips to customize the interaction between Finch, Telemetry, and Phoenix Live Dashboard"><meta property="og:type" content="article"><meta property="og:url" content="http://claudio-ortolina.org/posts/tips-for-finch-and-telemetry/"><meta property="og:image" content="http://claudio-ortolina.org/img/tips-for-finch-and-telemetry/charts.png"><meta property="article:published_time" content="2020-11-17T17:27:05+00:00"><meta property="article:modified_time" content="2020-11-17T17:27:05+00:00"><meta property="og:site_name" content="Claudio Ortolina"><script defer data-domain=claudio-ortolina.org src=https://plausible.io/js/plausible.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Claudio Ortolina</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/talks>Talks</a></li><li><a href=https://github.com/cloud8421/claudio-ortolina.org>Source</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/talks>Talks</a></li><li><a href=https://github.com/cloud8421/claudio-ortolina.org>Source</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Tips for Finch, Telemetry, and Phoenix Live Dashboard</h1><div class=post-meta><span class=post-date>2020-11-17</span>
<span class=post-read-time>— 3 min read</span></div><span class=post-tags><a href=http://claudio-ortolina.org/tags/elixir/>#elixir</a>&nbsp;
<a href=http://claudio-ortolina.org/tags/software-development/>#software development</a>&nbsp;</span><div class=post-content><p>While working on <a href=https://github.com/fully-forged/tune>Tune</a>, I needed to collect performance metrics related to the interaction with the Spotify API.</p><p>The Finch HTTP client <a href=https://hexdocs.pm/finch/Finch.html#module-telemetry>exposes Telemetry metrics</a>, which made it very easy to display them via <a href=https://hex.pm/packages/phoenix_live_dashboard>Phoenix Live Dashboard</a>.</p><p>Starting from the stock <code>TuneWeb.Telemetry</code> file generated by Phoenix (see <a href=https://hexdocs.pm/phoenix/telemetry.html#content>the official guides for an explanation</a>), I just added two new summary metrics to the <code>metrics/0</code> function:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>  summary(<span style=color:#e6db74>&#34;vm.total_run_queue_lengths.io&#34;</span>),

  <span style=color:#75715e># HTTP</span>
  summary(<span style=color:#e6db74>&#34;finch.request.stop.duration&#34;</span>, <span style=color:#e6db74>unit</span>: {<span style=color:#e6db74>:native</span>, <span style=color:#e6db74>:millisecond</span>}, <span style=color:#e6db74>tags</span>: [<span style=color:#e6db74>:path</span>]),
  summary(<span style=color:#e6db74>&#34;finch.response.stop.duration&#34;</span>, <span style=color:#e6db74>unit</span>: {<span style=color:#e6db74>:native</span>, <span style=color:#e6db74>:millisecond</span>}, <span style=color:#e6db74>tags</span>: [<span style=color:#e6db74>:path</span>])
]</code></pre></div></div><p>With this change in place (<a href=https://github.com/fully-forged/tune/commit/7c573aa30313a8adf1954076b9cd957f0f910155>commit</a>), I had all metrics being visualized in the dashboard, grouped by the Spotify API path. I wanted to make some improvements:</p><ul><li><p>The <code>:path</code> tag includes query string parameters, so calls like <code>search?q=marillion</code> and <code>search?q=fish</code> would be aggregated in different groups. Instead, I would want them to be part of the same group, ignoring query string parameters.</p></li><li><p>Since I <a href=http://claudio-ortolina.org/posts/using-finch-with-sentry/>setup Sentry to use Finch as a client</a>, I wanted to exclude calls made to Sentry and only have charts reporting metrics about the interaction with Spotify</p></li></ul><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Aggregating by normalized path</h2><div id=outline-text-headline-1 class=outline-text-2><p>To aggregate metrics by normalized path, we can apply a transformation function to the metric tag values, generate a normalized path tag and use that to aggregate metrics. As shown <a href=https://hexdocs.pm/telemetry_metrics/Telemetry.Metrics.html#module-metrics>in the telemetry_metrics docs</a>, the option we need is <code>tag_values</code>:</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#66d9ef>def</span> metrics <span style=color:#66d9ef>do</span>
  [
    <span style=color:#75715e># omitted</span>
    summary(<span style=color:#e6db74>&#34;finch.request.stop.duration&#34;</span>,
        <span style=color:#e6db74>unit</span>: {<span style=color:#e6db74>:native</span>, <span style=color:#e6db74>:millisecond</span>},
        <span style=color:#e6db74>tags</span>: [<span style=color:#e6db74>:normalized_path</span>],
        <span style=color:#e6db74>tag_values</span>: <span style=color:#f92672>&amp;</span>add_normalized_path<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>
    )
  ]
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>defp</span> add_normalized_path(metadata) <span style=color:#66d9ef>do</span>
  <span style=color:#a6e22e>Map</span><span style=color:#f92672>.</span>put(metadata, <span style=color:#e6db74>:normalized_path</span>, <span style=color:#a6e22e>URI</span><span style=color:#f92672>.</span>parse(metadata<span style=color:#f92672>.</span>path)<span style=color:#f92672>.</span>path)
<span style=color:#66d9ef>end</span></code></pre></div></div><p>We can use the built-in <code>URI</code> module to parse normalized path out of the Finch metric metadata and add it to the metadata itself. With that in place, we can update the <code>tags</code> option to reference <code>:normalized_path</code>. With this change, metrics are aggregated on the endpoint only, without any query string. For reference, here's the relevant <a href="https://github.com/fully-forged/tune/commit/8ab6fab59357e97579ac086a94e768193c2872a5?branch=8ab6fab59357e97579ac086a94e768193c2872a5&diff=unified">commit</a>.</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Filtering only Spotify calls</h2><div id=outline-text-headline-2 class=outline-text-2><p>To filter for Spotify calls only, we can use the <code>keep</code> option, which specifies a predicate function that can be used to define which metrics should be kept and which ones should be discarded. Discarded metrics will not appear in the dashboard chart.</p><div class="src src-elixir"><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#66d9ef>def</span> metrics <span style=color:#66d9ef>do</span>
  [
    <span style=color:#75715e># omitted</span>
    summary(<span style=color:#e6db74>&#34;finch.response.stop.duration&#34;</span>,
      <span style=color:#e6db74>unit</span>: {<span style=color:#e6db74>:native</span>, <span style=color:#e6db74>:millisecond</span>},
      <span style=color:#e6db74>tags</span>: [<span style=color:#e6db74>:normalized_path</span>],
      <span style=color:#e6db74>tag_values</span>: <span style=color:#f92672>&amp;</span>add_normalized_path<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>,
      <span style=color:#e6db74>keep</span>: <span style=color:#f92672>&amp;</span>keep_spotify<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>,
      <span style=color:#e6db74>reporter_options</span>: [
        <span style=color:#e6db74>nav</span>: <span style=color:#e6db74>&#34;HTTP - Spotify&#34;</span>
      ]
    )
  ]
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>defp</span> keep_spotify(meta) <span style=color:#66d9ef>do</span>
  meta<span style=color:#f92672>.</span>host <span style=color:#f92672>=~</span> <span style=color:#e6db74>&#34;spotify&#34;</span>
<span style=color:#66d9ef>end</span></code></pre></div></div><p>As the meta information already includes a host, we can compare it with the <code>spotify</code> string. The <code>=~</code> operator makes the comparison a bit more resilient, so that we don't have to worry about the exact hostname, rather a hostname related to Spotify. This choice might need to be revised if we ever end up interacting via HTTP with another service with "spotify" in their host name (unlikely, but possible).</p><p>For some additional clarity, we can also use the <code>nav</code> reporter option (see <a href=https://hexdocs.pm/phoenix_live_dashboard/metrics.html#reporter-options>Phoenix LiveDashboard documentation</a> for more details) to make sure that the navigation header displays a name that details the additional filter applied to the HTTP metrics. For reference, see the relevant <a href=https://github.com/fully-forged/tune/commit/c9f483d93c0813c0e680a4aaf2a88fed0851334f#diff-f599bf85f0cafc16b50f0e1a561b6aa39e4ab256fb6d43e8726619570866c5b1>commit</a>.</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Conclusion</h2><div id=outline-text-headline-3 class=outline-text-2><p>Both improvements required very small updates. Here's the final result, showing the custom Nav title ("HTTP - Spotify") to hint at the filter used to only show Spotify calls, and aggregation by normalized path (without query string).</p><p><img src=/img/tips-for-finch-and-telemetry/charts.png alt="A screenshot of the configured Finch Metrics inside Live Dashboard" class=left></p><p>All in all, I was pleased to see that it was straightforward to customise the charts I needed. One thing I haven't worked on yet is aggregating metrics by logical path, i.e. by route (<code>GET /artist/:id</code>) instead of individual paths (<code>GET /artist/123</code>), but I have some ideas and will come back on it in a future post.</p></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=http://claudio-ortolina.org/posts/building-a-custom-page-for-phoenix-live-dashboard/><span class=button__icon>←</span>
<span class=button__text>Building a Custom Page for Phoenix Live Dashboard</span></a></span>
<span class="button next"><a href=http://claudio-ortolina.org/posts/using-finch-with-sentry/><span class=button__text>Using Finch With Sentry</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><p xmlns:dct=http://purl.org/dc/terms/ xmlns:cc=http://creativecommons.org/ns# class=license-text><a rel=cc:attributionurl property="dct:title" href=https://claudio-ortolina.org>This website</a> by <a rel="cc:attributionurl dct:creator" property="cc:attributionName" href=https://claudio-ortolina.org>Claudio Ortolina</a> is licensed under <a rel=license href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a></p></div></div></footer><script src=http://claudio-ortolina.org/assets/main.js></script><script src=http://claudio-ortolina.org/assets/prism.js></script></div></body></html>